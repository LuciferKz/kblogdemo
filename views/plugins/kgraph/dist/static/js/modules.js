(window.webpackJsonp=window.webpackJsonp||[]).push([[1],[,function(e,t,n){"use strict";var i=[{key:"undo",title:"撤销"},{key:"redo",title:"重做"},{key:"cutOff"},{key:"copy",title:"复制"},{key:"paste",title:"粘贴"},{key:"delete",title:"删除"},{key:"cutOff"},{key:"zoomin",title:"放大"},{key:"zoomout",title:"缩小"},{key:"cutOff"},{key:"fitpagewidth",title:"适应画布"},{key:"fitpage",title:"实际尺寸"},{key:"cutOff"},{key:"tofront",title:"前置"},{key:"toback",title:"后置"}];t.a=function(r,a){var c=(this.graph=r).refs;kutil.newElement({tag:"div",ref:"toolbar",props:{className:"kgraph-toolbar-container"}},c);var e={hidden:!1,toolsHidden:!1,toolsConfig:{},modules:[]};kutil.extend(e,a),a=e,i.forEach(function(e){var t=a.toolsConfig[e.key];t&&kutil.extend(e,t)});var s={list:[],maps:{}},t=function(){var e=r.$ghistory.getStateId(),t=r.$ghistory.getLength();s.maps.undo.config.disabled=0===e,s.maps.redo.config.disabled=t-1<=e},n=function(){var e=!r.getSelectedDNode();s.maps.copy.config.disabled=e,s.maps.paste.config.disabled=e,s.maps.delete.config.disabled=e,s.maps.tofront.config.disabled=e,s.maps.toback.config.disabled=e},o=function(){s.list.forEach(function(e){return e.dom[e.config.disabled?"addClass":"removeClass"]("disabled")})};return kutil.newElement({tag:"div",ref:"tools",props:{className:"kgraph-toolbar"}},c),i.forEach(function(e){var t,n,o,i;"cutOff"===e.key?(i=kutil.newElement({tag:"div",props:{className:"cut-off"}}),c.tools.append(i)):!e.hidden&&(t=e,n=kutil.newElement({tag:"div",props:{title:t.title,className:"iconfont icon-"+t.key+" disabled"},evts:{click:function(){if(a.disabled)return!1;r.$trigger(t.key)}}}),o={name:t.key,config:t,dom:n},s.maps[t.key]=o,s.list.push(o),c.tools.append(n))}),c.toolbar.append(c.tools),a.modules.forEach(function(e){return e(c,r)}),a.hidden&&c.toolbar.hide(),a.toolsHidden&&c.tools.hide(),{updateTools:function(){t(),n(),o()}}}},function(e,t,n){"use strict";var u=n(0);t.a=function(s,e){var n=kutil.newElement({tag:"div",props:{className:"kgraph-sidebar-container"}}),a={list:[],maps:{}};s.sbdnodes=a,e=e||{};var c=s.refs,o=function(e,t){var n=kutil.newElement({tag:"div",props:{className:"sidebar-section-item item-"+t.key},children:[{tag:"i",ref:"icontext",props:{className:"iconfont",innerHTML:t.iconText}},{tag:"span",props:{innerText:t.text}}]},c);e.append(n),t.width=140,t.height=40,t.icon=c.icontext.text(),t.text=t.text;var o,i,r=(o=t,(i=function(e,t){this.isEdited=o.isEdited,u.d.apply(this,[e,t])}).prototype=Object.create(u.d.prototype),Object.assign(i.prototype,o),i.prototype.constructor=i);a.list.push(r),a.maps[t.key]=r,l(t,n)},l=function(n,e){var o,t={},i=!1,r=!1,a=function(e){if(!i){if(!(10<Math.abs(t.x-e.clientX)||10<Math.abs(t.y-e.clientY)))return!1;i=!0,o=d(n,t.x,t.y)}e.clientX>s.clientRect.left&&e.clientX<s.clientRect.right&&e.clientY>s.clientRect.top&&e.clientY<s.clientRect.bottom?r||(r=!0,o.css({width:n.width*s.scale+"px",height:n.height*s.scale+"px"})):r&&(r=!1,o.css({width:n.width+"px",height:n.height+"px"})),o.css({transform:"translate("+(e.clientX-t.x)+"px, "+(e.clientY-t.y)+"px)"})},c=function e(t){i?o&&(o.remove(),s.$trigger("insert",n.key,"drag",{},{x:t.clientX-s.clientRect.left,y:t.clientY-s.clientRect.top})):s.$trigger("insert",n.key,"click"),i=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e)};e.on("mousedown",function(e){1===e.which&&(t.x=e.clientX,t.y=e.clientY,document.addEventListener("mousemove",a),document.addEventListener("mouseup",c))})},d=function(e,t,n){var o=kutil.newElement({tag:"div",style:{width:e.width+"px",height:e.height+"px",border:"1px dashed #333",position:"absolute",top:n+"px",left:t+"px",zIndex:999,transform:"translate(0, 0)"}});return $k("body").append(o),o};return kutil.newElement({tag:"i",props:{className:"button-open-sidebar iconfont icon-fenlei1"},ref:"buttonOpenSlidebar",evts:{click:function(){n.removeClass("collapse"),setTimeout(function(){s.resize()},200)}}},c),n.append(c.buttonOpenSlidebar),e.hidden&&n.hide(),{container:n,createSection:function(e,t){kutil.newElement({tag:"div",props:{className:"sidebar-section"},ref:"sidebarSection",children:[{tag:"div",props:{className:"sidebar-section-title"},children:[{tag:"i",props:{className:"iconfont icon-fenlei1"},evts:{click:function(){n.addClass("collapse"),setTimeout(function(){s.resize()},200)}}},{tag:"span",props:{innerText:e}}]},{tag:"div",ref:"seciontItems",props:{className:"sidebar-section-items"}}]},c),t.forEach(function(e){o(c.seciontItems,e)}),n.append(c.sidebarSection)}}}},function(e,t,n){"use strict";t.a=function(t,e){var n=t.refs;e=e||{};var o=kutil.newElement({tag:"div",ref:"footer",props:{className:"kgraph-footer-container"}},n);return kutil.newElement({tag:"div",ref:"diagramScale",props:{className:"diagram-scale"},children:[{tag:"div",props:{className:"scale"},evts:{click:function(){console.log("click")}},children:[{tag:"div",ref:"scaleBar",props:{className:"scale-bar"},style:{width:"50%"},children:[{tag:"div",props:{className:"scale-drag"}}]}]},{tag:"div",props:{className:"zoom"},children:[{tag:"div",ref:"zoomOut",props:{className:"scale-zoom-out iconfont icon-jian"}},{tag:"div",ref:"scaleValue",props:{className:"scale-value",innerHTML:"100%"}},{tag:"div",ref:"zoomIn",props:{className:"scale-zoom-in iconfont icon-jia"}}]}]},n),n.zoomOut.on("click",function(){t.$trigger("zoomout")}),n.zoomIn.on("click",function(){t.$trigger("zoomin")}),o.append(n.diagramScale),e.hidden&&o.hide(),e.modules&&e.modules.forEach(function(e){return e(n,t)}),{container:o,scaleChanged:function(e){n.scaleValue.html(Math.ceil(100*e)+"%"),n.scaleBar.css({width:e/2*100+"%"})},directionChanged:function(e){n.fieldbar&&n.fieldbar.attrs({class:"graph-mode "+e})}}}},function(e,t,n){"use strict";var Re=n(5),He=n(0);t.a=function(l,d){var u,f,m,o,i,t=this,e=kutil.newElement({tag:"div",props:{className:"kgraph-diagram-container"}});t.graph=l,d=d||{};var n,r,a,c,p,s,g,v,h,y,x,b,w,E,k,N,C,L,S,B=0,z=0,O=!1,D=null,P=1,M=1,X=0,Y=0,T=null,R=null,H=new Re.a,I=l.refs,W={createScrollContainer:function(){kutil.newElement({tag:"div",ref:"scrollContainer",props:{className:"scroll-container"},children:[{tag:"div",props:{className:"scroll-vertical-container"},children:[{tag:"div",ref:"scrollVerBar",props:{className:"scroll-bar"}}]},{tag:"div",props:{className:"scroll-horizontal-container"},children:[{tag:"div",ref:"scrollHorBar",props:{className:"scroll-bar"}}]}]},I),I.diagramDragLayer.onWheel(function(e){e.preventDefault(),(a||c)&&(a&&(B+=20*e.deltaY),c&&(z+=20*e.deltaX),W.triggerScroll())}),I.scrollVerBar.on("mousedown",function(e){W.mousedown(e,"vertical")}),I.scrollHorBar.on("mousedown",function(e){W.mousedown(e,"horizontal")}),I.scrollContainer.insertBefore(I.diagramDragLayer)},triggerScroll:function(){m-n<B?B=m-n:B<0&&(B=0),f-r<z?z=f-r:z<0&&(z=0),I.scrollVerBar.css({transform:"translate(0px, "+B+"px)"}),I.scrollHorBar.css({transform:"translate("+z+"px, 0px)"}),G(X=-z/f*(o*M),Y=-B/m*(i*M)),Be()},triggerScrollByOffset:function(){B=-Y/(i*M)*m,z=-X/(o*M)*f,I.scrollVerBar.css({transform:"translate(0px, "+B+"px)"}),I.scrollHorBar.css({transform:"translate("+z+"px, 0px)"}),G(X,Y)},resizeScrollBar:function(){m<i*M?(n=m*m/(i*M),I.scrollVerBar.css({height:n+"px"}),a=!0,I.scrollVerBar.show()):(a=!1,I.scrollVerBar.hide()),f<o*M?(r=f*f/(o*M),I.scrollHorBar.css({width:r+"px"}),c=!0,I.scrollHorBar.show()):(c=!1,I.scrollHorBar.hide())}},$=function(e){var t=W[e];W[e]=function(){d.scroll&&t()}};for(var A in W)$(A);kutil.extend(W,{downPoint:null,prevPoint:null,direction:"vertical",mousedown:function(e,t){W.direction=t,W.prevPoint={x:e.clientX,y:e.clientY},document.addEventListener("mousemove",W.mousemove),document.addEventListener("mouseup",W.mouseup)},mousemove:function(e){"vertical"===W.direction?B+=e.clientY-W.prevPoint.y:"horizontal"===W.direction&&(z+=e.clientX-W.prevPoint.x),W.triggerScroll(),W.prevPoint={x:e.clientX,y:e.clientY}},mouseup:function(e){document.removeEventListener("mousemove",W.mousemove),document.removeEventListener("mouseup",W.mouseup)}});var V={downPoint:{},mousedown:function(e){if(V.downPoint.x=e.clientX-X,V.downPoint.y=e.clientY-Y,!p)return!1;d.dragable&&document.addEventListener("mousemove",V.mousemove),document.addEventListener("mouseup",V.mouseup)},mousemove:function(e){X=e.clientX-V.downPoint.x,Y=e.clientY-V.downPoint.y,H.setOffset(X,Y),Be()},mouseup:function(e){U(null),d.dragable&&document.removeEventListener("mousemove",V.mousemove),document.removeEventListener("mouseup",V.mouseup)}},F=function(){b=[],w={},E=[],k={},N=[],C={},s=d.startX||60,g=d.startY||60,v=d.direction||"vertical","full"===d.diagramSize?(o=f,i=m):(o=d.diagramWidth||602,i=d.diagramHeight||802,X="left"===d.horizontalAlign?0:(f-o)/2<0?0:(f-o)/2,Y="top"===d.verticalAlign?0:(m-i)/2<0?0:(m-i)/2),h=d.gridWidth||10,y=d.gridLineWidth||2,x=void 0===d.gridAlign||d.gridAlign,p=!0,t.diagramWidth=o,H.clearEvent()},j=function(){kutil.newElement({tag:"div",ref:"main",props:{className:"kgraph-diagram"},children:[{tag:"canvas",ref:"canvas",props:{id:"canvas"},style:{backgroundColor:"#f8fbfb"}},{tag:"div",ref:"diagramDragLayer",props:{className:"diagram-drag-layer"}}]},I),d.header&&e.append(d.header),W.createScrollContainer(),t.ctx=u=I.canvas.dom.getContext("2d"),J(),e.append(I.main)},J=function(){He.e.prototype.ctx=t.ctx,He.a.prototype.ctx=t.ctx,He.b.prototype.ctx=t.ctx,He.c.prototype.ctx=t.ctx},q=function(e){D=I.contextMenu,I.contextMenu.css({display:"block",left:e.clientX-L.left+"px",top:e.clientY-L.top+"px"})},K=function(){p=!0,D=null,I.contextMenu.hide()},G=function(e,t){X=e,Y=t,H.setOffset(X,Y)},Q=function(){canvas.width=0,canvas.height=0,L=I.diagramDragLayer.dom.getBoundingClientRect(),o=o<f?f:o,i=i<m?m:i,l.clientRect=L,canvas.width=L.width,canvas.height=L.height,t.caWidth=f=L.width,m=L.height,W.resizeScrollBar(),H.setClientRect(L)},U=function(e){T&&T!==e&&(T.blur(),oe(T,"del")),T=e,l.updateFormat(),l.updateToolbar(),Be()},Z=function(e){ee(e,"update"),te(e,"update"),ne(e,"update"),oe(e,"update")},_=function(){p=!1,document.removeEventListener("mousemove",V.mousemove),document.removeEventListener("mouseup",V.mouseup)},ee=function(e,t){ie(e,t)},te=function(e,t){ce(e).forEach(function(e){ie(e,t)})},ne=function(e,t){if(!e.cmbutton)return!1;ie(e.cmbutton,t)},oe=function(e,t){e.cmenu.forEach(function(e){ie(e,t)})},ie=function(e,t){var n=t+"Event";H[n](e,"mouseenter"),H[n](e,"mousedown"),H[n](e,"mouseleave")},re=function(e,t,n,o){var i=l.sbdnodes.maps[e];if(!i)return console.error("未找到key: "+e+"对应的节点"),null;i.prototype.ctx=u;var r=new i(n||{});switch(r.key=e,t){case"click":var a=Ne(r);r.move(a.x,a.y);break;case"copy":r.reset(),(R=r).id=kutil.guid(),r.move(R.x+h,R.y+h);break;case"drag":if(x){var c=o.x-X,s=o.y-Y;o.x=c<0?0:c-c%h,o.y=s<0?0:s-s%h}case"cmitem":r.move(o.x,o.y)}return b?b.push(r):b=[r],w[r.id]=r,Ee(r),"restore"===t||ke({t:r.y,l:r.x,b:r.y+r.height,r:r.x+r.width})||(Y=0<m-r.y-r.height-10?0:m-r.y-r.height-10,X=0<f-r.x-r.width-10?0:f-r.x-r.width-10,W.triggerScrollByOffset()),ue(r),d.afterInsertDNode&&d.afterInsertDNode(r,P,t),P++,r},ae=function(e,t){t&&(e.position=t);var n=new He.a(e);n.init(),fe(n),N.push(n),C[n.id]=n},ce=function(t){return N.filter(function(e){return e.parentNode===t})},se=function(e){var t=new He.e(e);E.push(t),"multiple"!==(k[t.id]=t).start.parentNode.connectRule&&(t.start.parentNode.hideCMButton(),ne(t.start.parentNode,"del")),d.afterCreatePath&&d.afterCreatePath(t)},le=function(t){return E.filter(function(e){return e.start.parentNode===t||e.end.parentNode===t})},de=function(t){return E.filter(function(e){return e.start===t||e.end===t})},ue=function(o){var i={},r={},a=!1;o.init(v),o.nextSiblings&&(o.cmbutton=new He.b,o.cmbutton.init(o)),o.cmenu.length?o.cmenu.forEach(function(e){e.follow(o,"dnode init")}):o.nextSiblings&&o.nextSiblings.length&&(o.nextSiblings.forEach(function(e){var t=l.sbdnodes.maps[e];if(t){var n=new He.c(e,o.cmenu.length);n.setText(t.prototype.text),n.setIcon(t.prototype.icon),o.cmenu.push(n)}}),o.cmenu.forEach(function(e){e.follow(o,"dnode init")})),ge(o);var c=function(e){if(Math.abs(i.x-e.clientX)<5&&Math.abs(i.y-e.clientY)<5)return!1;a=!0,o.drag();var t=e.clientX-i.x,n=e.clientY-i.y;x&&(t-=t%h,n-=n%h),o.moveDragDNode(r.x+Xe(t),r.y+Xe(n)),Be()},s=function e(t){p=!0,document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",e),a?(a=!1,o.drop(),ge(o),ce(o).forEach(function(e){e.follow()}),Ee(o),Z(o),Be(),Se("drop dnode")):(U(o),o.focus())};H.addEvent(o,"mouseenter",function(){I.diagramDragLayer.addClass("move"),o.enter(),Be()},{cancelBubble:!0}),H.addEvent(o,"mousedown",function(e){var t,n;_(),1===e.which?(t=e,i.x=t.clientX,i.y=t.clientY,r.x=o.x,r.y=o.y,document.addEventListener("mousemove",c),document.addEventListener("mouseup",s)):3===e.which&&d.contextMenu&&(U(o),o.focus(),n=e,I.contextMenu||(kutil.newElement({tag:"div",ref:"contextMenu",props:{className:"diagram-context-menu"}},I),[{action:"delete",text:"删除"}].forEach(function(e){var t=kutil.newElement({tag:"div",props:{className:"context-menu-item",textContent:e.text}});t.on("mousedown",function(e){Ye("delete")}),I.contextMenu.append(t)}),document.addEventListener("mousedown",function(){D&&K()}),I.diagramDragLayer.append(I.contextMenu)),q(n),e.stopPropagation(),e.cancelBubble=!0)},{cancelBubble:!0}),H.addEvent(o,"mouseleave",function(){I.diagramDragLayer.removeClass("move"),o.leave(),Be()});var e=function(e){var t=o.evts[e];kutil.extend(t.options||{},{cancelBubble:!0}),H.addEvent(o,e,function(e){t.cb(e,o)},t.options)};for(var t in o.evts)e(t);o.cmbutton&&me(o)},fe=function(i){var n={},r=function(e){S.move(Xe(e.pageX-L.left-X),Xe(e.pageY-L.top-Y)),Be()},o=function e(t){O=!(p=!0);var n=ye({x:Xe(t.pageX-L.left-X),y:Xe(t.pageY-L.top-Y)});if(n){var o=we(i,n);o?l.message({type:"error",message:o}):(S.closePath(n),se(S),i.connect(),n.connect(),Se("add path"))}S=null,Be(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",e)};H.addEvent(i,"mouseenter",function(){I.diagramDragLayer.addClass("auto")}),H.addEvent(i,"mousedown",function(e){var t={dir:v};"start"===i.type?t.end=i:t.start=i,S=new He.e(t),O=!0,n.x=e.pageX,n.y=e.pageY,_(),document.addEventListener("mousemove",r),document.addEventListener("mouseup",o)},{cancelBubble:!0}),H.addEvent(i,"mouseleave",function(){I.diagramDragLayer.removeClass("auto")})},me=function(t){H.addEvent(t.cmbutton,"mouseenter",function(){I.diagramDragLayer.addClass("pointer")}),H.addEvent(t.cmbutton,"mousedown",function(){t.showMenu(),t.cmenu.forEach(function(e){pe(t,e)}),Be()}),H.addEvent(t.cmbutton,"mouseleave",function(){I.diagramDragLayer.removeClass("pointer")})},pe=function(i,e){H.addEvent(e,"mouseenter",function(){e.enter(),I.diagramDragLayer.addClass("pointer"),Be()}),H.addEvent(e,"mousedown",function(){e.leave(),l.$trigger("insert",e.key,"cmitem",{},"vertical"===v?{x:i.x,y:i.y+i.height+60}:{x:i.x+i.width+60,y:i.y},function(e){var t=ce(i).slice(-1)[0],n=ce(e)[0],o=we(t,n);o?(l.message({type:"error",message:o}),l.$trigger("delete",e)):(se({start:t,end:n,dir:v}),t.connect(),n.connect(),Se("add path and dnode"))}),I.diagramDragLayer.removeClass("pointer")},{cancelBubble:!0}),H.addEvent(e,"mouseleave",function(){I.diagramDragLayer.removeClass("pointer"),e.leave(),Be()})},ge=function(e){var t=ve(e);ke(t)||he(e,t)},ve=function(e){var t=e.cmenu.slice(-1)[0]||{},n=e.cmenu.slice(-2,-1)[0]||t,o=e.cmenu.length;return"horizontal"===v?o%2?{t:t.y,l:t.x,b:n.y+n.height,r:t.x+t.width}:{t:n.y,l:t.x,b:t.y+t.height,r:t.x+t.width}:"vertical"===v?o%2?{t:t.y,l:t.x,b:t.y+t.height,r:n.x+n.width}:{t:t.y,l:n.x,b:t.y+t.height,r:t.x+t.width}:void 0},he=function(t,e){e.l<-X?t.cmenuOffsetX=X-e.l:e.r>-X+f&&(t.cmenuOffsetX=-X+f-e.r),i<e.b?i=e.b+90:e.t<-Y?t.cmenuOffsetY=-Y-e.t:e.b>-Y+m&&(t.cmenuOffsetY=-Y+m-e.b),t.cmenu.forEach(function(e){e.follow(t,"moveCMenuItems")})},ye=function(t){var n=null;return N.forEach(function(e){e.x-e.outlineR<t.x&&e.x+2*e.outlineR>t.x&&e.y-e.outlineR<t.y&&e.y+2*e.outlineR>t.y&&(n=e)}),n},xe=function(e,t){if("inherit"===e.connectRule){var n=le(e);n&&0<n.length&&(e=n[0]["start"===t?"end":"start"].parentNode)}return e},be=function(e){var n=null;return ce(e).find(function(e){if("start"===e.type){var t=de(e);0<t.length&&(n=t[0].start.parentNode)}}),n},we=function(e,t){if(e.position===t.position)return"start"===e.type?"需要连接节点开始位置":"需要连接节点结束位置";var n,o;"end"===e.type?(n=e,o=t):"start"===e.type&&(n=t,o=e);var i=xe(n.parentNode,n.type),r=xe(o.parentNode,o.type),a=d.verifyConnection&&d.verifyConnection(n,o);if(a)return a;var c=i.nextSiblings;return c&&!~c.indexOf(r.key)?i.text+"节点只能连接"+c.map(function(e){return l.sbdnodes.maps[e]&&l.sbdnodes.maps[e].prototype.text}).join(",")+"节点":i.verifyConnection&&i.verifyConnection(i,i,r)||r.verifyConnection&&r.verifyConnection(r,i,r)},Ee=function(e){e.x>o-e.width-100&&(t.diagramWidth=o=e.x+e.width+100),e.y>i-100&&(i=e.y+e.height+100),W.resizeScrollBar()},ke=function(e){return!(e.t<-Y||e.l<-X||e.b+Y>m||e.r+X>f)},Ne=function(e){var t,n=s,o=g;if(d.dragable||d.scroll){var i=(t={x:0,y:0},Ce(function(e){"horizontal"===v?t.x=Math.max(t.x,e.x):"vertical"===v&&(t.y=Math.max(t.y,e.y))}),t);0<i.y?o=i.y+e.height+20:0<i.x&&(n=i.x+e.width+20)}return 0===b.length&&("horizontal"===v?o=m/2-20:"vertical"===v&&(n=f/2-80)),{x:n,y:o}},Ce=function(e){for(var t=0,n=b.length;t<n;t++)e(b[t],t,b)},Le=function(e,t){if(!e)return!1;F();var n=JSON.parse(e);console.log(n),M=n.scale,l.scaleChanged(M),v=n.direction,l.directionChanged(v),console.log(v),n.dnodes.map(function(e){return re(e.key,"restore",e)}),n.connects.map(function(e){return e.parentNode=w[e.parentNode]||{},ae(e)}),n.paths.map(function(e){return e.start=C[e.start]||{},e.end=C[e.end]||{},se(e)}),o=n.diagramWidth,i=n.diagramHeight,n.diagramWidth<f&&"full"===d.diagramSize&&(o=f),h=n.gridWidth,y=n.gridLineWidth,x=n.gridAlign,P=n.currentId,W.triggerScrollByOffset(),U(null)},Se=function(e){var t=JSON.stringify({dnodes:b.map(function(e){var t=kutil.clone(e);return delete t.cmbutton,delete t.cmenu,t}),connects:N.map(function(e){var t=kutil.clone(e);return t.parentNode=t.parentNode.id,t}),paths:E.map(function(e){var t=kutil.clone(e);return t.start=t.start.id,t.end=t.end.id,delete t.points,t}),diagramWidth:o,diagramHeight:i,gridWidth:h,gridAlign:x,scale:M,direction:v,currentId:P});l.$ghistory.saveState(t),l.updateToolbar()},Be=function(e){requestAnimationFrame(function(){u.clearRect(0,0,f,m),u.save(),u.translate(X,Y),u.scale(M,M),ze(),Oe(),Me(),Pe(),u.restore()})},ze=function(){var e=0,t=0;for(u.beginPath(),u.strokeStyle="#EEEEEE",u.lineWidth=y;t<i;)u.moveTo(0,t),u.lineTo(o,t),t+=h;for(;e<o;)u.moveTo(e,0),u.lineTo(e,i),e+=h;u.stroke()},Oe=function(){Ce(function(e){e.draw(),De(e)})},De=function(e){ce(e).forEach(function(e){O&&e.drawOutline(),e.draw()})},Pe=function(){Ce(function(e){e.isShowMenu&&(e.cmenu.forEach(function(e){e.draw()}),e.cmenu.forEach(function(e){e.entering&&e.drawTitle()}))})},Me=function(){S&&S.draw(),E.forEach(function(e){e.connectPoints(),e.draw()})},Xe=function(e){return e/M},Ye=function(e){var t=Array.from(arguments).slice(1);Te[e].apply(Te,t),"undo"===e||"redo"===e?Be("restore"):Be()},Te={insert:function(e,t,n,o,i){var r,a;if(!d.beforeInsertDNode||d.beforeInsertDNode(e,t,n)){var c=re(e,t,n,o);a={parentNode:r=c},"vertical"===v?(r.top&&ae(a,"top"),r.bottom&&ae(a,"bottom")):"horizontal"===v&&(r.left&&ae(a,"left"),r.right&&ae(a,"right")),Se("insert"),i&&i(c)}},copy:function(){R=T},paste:function(){if(!R)return!1;this.insert(R.key,"copy",R),Se("paste")},splice:function(){var o=null,i=null;return Ce(function(e,t,n){e===T&&(i=n,o=t)}),U(null),i.splice(o,1)[0]},delete:function(e){var t,n=e||T;U(null),ee(t=n,"del"),te(t,"del"),ne(t,"del"),oe(t,"del"),b.splice(b.indexOf(n),1),delete w[n.id],le(n).forEach(function(e){e.start.parentNode.showCMButton(),e.start.parentNode.cmbutton&&me(e.start.parentNode),E.splice(E.indexOf(e),1),0===de(e.start).length&&e.start.disConnect(),0===de(e.end).length&&e.end.disConnect()}),ce(n).forEach(function(e){N.splice(N.indexOf(e),1),delete C[e.id]}),Se("delete dnode")},tofront:function(){var e=this.splice();b.push(e),H.moveEvent(e,"push"),ce(e).forEach(function(e){H.moveEvent(e,"push")}),e.cmbutton&&H.moveEvent(e.cmbutton,"push"),Se("dnode to front")},toback:function(){var e=this.splice();b.unshift(e),H.moveEvent(e,"unshift"),ce(e).forEach(function(e){H.moveEvent(e,"unshift")}),e.cmbutton&&H.moveEvent(e.cmbutton,"unshift"),Se("dnode to back")},undo:function(){Le(l.$ghistory.prevState())},redo:function(){Le(l.$ghistory.nextState())},zoomin:function(){M=M<2?kutil.sum(M,.2):2,l.scaleChanged(M),Se("scale changed")},zoomout:function(){M=.6<M?kutil.minus(M,.2):.6,l.scaleChanged(M),Se("scale changed")},fitpage:function(){M=1,l.scaleChanged(M),Se("scale changed")},fitpagewidth:function(){M=parseFloat((f/o).toFixed(2)),l.scaleChanged(M),Se("scale changed")},editText:function(){Se("edit dnode text")},changeDir:function(e){v=e,l.directionChanged(e),Se("direction changed")}};return kutil.extend(l,{$trigger:Ye,getSelectedDNode:function(){return T}}),kutil.extend(t,{reset:F,reboot:function(){J()},refs:I,draw:Be,container:e,initCanvas:function(){H.init(I.diagramDragLayer),Q(),F(),G(X,Y),l.directionChanged(d.direction),I.diagramDragLayer.on("mousedown",V.mousedown),Be(),Se("init diagram")},resizeCanvas:Q,scaleChanged:function(){var e=f-o*M,t=m-i*M;X=0<e?e/2:0,Y=0<t?t/2:0,H.setOffset(X,Y),H.setScale(M),W.resizeScrollBar()},directionChanged:function(n){N.forEach(function(e){"vertical"===v?"left"===e.position?e.setPosition("top"):"right"===e.position&&e.setPosition("bottom"):"horizontal"===v&&("top"===e.position?e.setPosition("left"):"bottom"===e.position&&e.setPosition("right"))}),b.forEach(function(t){t.dir=n,t.cmenuOffsetX=0,t.cmenuOffsetY=0,t.cmenu.forEach(function(e){e.follow(t,"directionChanged")}),ge(t),Z(t)}),E.forEach(function(e){e.dir=n})},saveState:Se,restoreState:Le,clearState:function(){F(),W.resizeScrollBar(),Be()},getPathsMaps:function(){return k},getAllDNodes:function(){return b},getConnects:ce,getAllConnects:function(){return N},getAllPaths:function(){return E},getPrevSibling:be,getPrevSiblingByKey:function(e,t){for(var n=be(e);n&&n.key!==t;)n=be(n);return n},getNextSibling:function(e){var n=null;return ce(e).forEach(function(e){if("end"===e.type){var t=de(e);0<t.length&&(n=t[0].end.parentNode)}}),n}}),j(),t}},,function(e,t,n){"use strict";var o=function(e,t,n){var o={},i=kutil.newElement({tag:"div",props:{className:n},children:[{tag:"div",props:{className:"format-title"},children:[{tag:"i",props:{className:"iconfont icon-fenlei1"}},{tag:"span",props:{innerText:t}}]},{tag:"div",ref:"formatForm",props:{className:"format-form"}}]},o);return e.container.append(i),{clearForm:function(){o.formatForm.html("")},append:function(e){o.formatForm.append(e)},show:function(){i.css({display:"block"})},hide:function(){i.css({display:"none"})}}};t.a=o}]]);